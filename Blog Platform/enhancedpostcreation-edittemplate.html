{% extends 'blog/base.html' %}

{% block title %}
    {% if form.instance.pk %}
        Edit Post - {{ form.instance.title }}
    {% else %}
        Write New Post
    {% endif %} - Mini Medium Clone
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow-sm">
            <div class="card-header bg-white border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="h4 mb-0">
                        {% if form.instance.pk %}
                            <i class="bi bi-pencil-square"></i> Edit Post
                        {% else %}
                            <i class="bi bi-plus-circle"></i> Write New Post
                        {% endif %}
                    </h2>
                    <a href="{% url 'blog:home' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Home
                    </a>
                </div>
            </div>
            
            <div class="card-body">
                <form method="post" id="post-form">
                    {% csrf_token %}
                    
                    <!-- Title Field -->
                    <div class="mb-4">
                        <label for="{{ form.title.id_for_label }}" class="form-label">
                            <i class="bi bi-card-heading"></i> Title
                        </label>
                        {{ form.title }}
                        {% if form.title.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.title.errors %}
                                    <small><i class="bi bi-exclamation-triangle"></i> {{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            <i class="bi bi-lightbulb"></i> 
                            Give your post a compelling title that captures the essence of your story
                        </div>
                    </div>

                    <!-- Content Field with Markdown Support -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label for="{{ form.content.id_for_label }}" class="form-label mb-0">
                                <i class="bi bi-text-paragraph"></i> Content
                            </label>
                            <div class="btn-group btn-group-sm" role="group">
                                <input type="radio" class="btn-check" name="editor-mode" id="write-mode" checked>
                                <label class="btn btn-outline-primary" for="write-mode">
                                    <i class="bi bi-pencil"></i> Write
                                </label>
                                <input type="radio" class="btn-check" name="editor-mode" id="preview-mode">
                                <label class="btn btn-outline-primary" for="preview-mode">
                                    <i class="bi bi-eye"></i> Preview
                                </label>
                            </div>
                        </div>
                        
                        <div class="editor-container">
                            <!-- Markdown Toolbar -->
                            <div class="markdown-toolbar mb-2">
                                <div class="btn-group btn-group-sm me-2" role="group">
                                    <button type="button" class="btn btn-outline-secondary" data-action="bold" title="Bold">
                                        <i class="bi bi-type-bold"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" data-action="italic" title="Italic">
                                        <i class="bi bi-type-italic"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" data-action="link" title="Link">
                                        <i class="bi bi-link"></i>
                                    </button>
                                </div>
                                <div class="btn-group btn-group-sm me-2" role="group">
                                    <button type="button" class="btn btn-outline-secondary" data-action="h1" title="Heading 1">
                                        <i class="bi bi-type-h1"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" data-action="h2" title="Heading 2">
                                        <i class="bi bi-type-h2"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" data-action="h3" title="Heading 3">
                                        <i class="bi bi-type-h3"></i>
                                    </button>
                                </div>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary" data-action="ul" title="Bullet List">
                                        <i class="bi bi-list-ul"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" data-action="ol" title="Numbered List">
                                        <i class="bi bi-list-ol"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" data-action="quote" title="Quote">
                                        <i class="bi bi-quote"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" data-action="code" title="Code">
                                        <i class="bi bi-code"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Editor Area -->
                            <div class="editor-area">
                                {{ form.content }}
                                <div id="preview-area" class="markdown-preview" style="display: none;">
                                    <div class="text-muted text-center py-5">
                                        <i class="bi bi-eye-slash"></i>
                                        <p>Start writing to see the preview...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {% if form.content.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.content.errors %}
                                    <small><i class="bi bi-exclamation-triangle"></i> {{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <div class="form-text">
                            <i class="bi bi-markdown"></i> 
                            This editor supports Markdown formatting. Use the toolbar above or type markdown directly.
                        </div>
                    </div>

                    <!-- Markdown Help -->
                    <div class="mb-4">
                        <button type="button" class="btn btn-link p-0 text-decoration-none" data-bs-toggle="collapse" data-bs-target="#markdown-help">
                            <i class="bi bi-question-circle"></i> Markdown Quick Reference
                        </button>
                        <div class="collapse mt-2" id="markdown-help">
                            <div class="card card-body bg-light">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Text Formatting</h6>
                                        <ul class="list-unstyled small">
                                            <li><code>**bold**</code> → <strong>bold</strong></li>
                                            <li><code>*italic*</code> → <em>italic</em></li>
                                            <li><code>`code`</code> → <code>code</code></li>
                                            <li><code>~~strikethrough~~</code> → <s>strikethrough</s></li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Structure</h6>
                                        <ul class="list-unstyled small">
                                            <li><code># Heading 1</code></li>
                                            <li><code>## Heading 2</code></li>
                                            <li><code>### Heading 3</code></li>
                                            <li><code>- List item</code></li>
                                            <li><code>1. Numbered item</code></li>
                                            <li><code>> Quote</code></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex justify-content-between">
                        <div>
                            <a href="{% url 'blog:home' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-primary me-2" id="save-draft">
                                <i class="bi bi-save"></i> Save Draft
                            </button>
                            <button type="submit" class="btn btn-primary">
                                {% if form.instance.pk %}
                                    <i class="bi bi-check-circle"></i> Update Post
                                {% else %}
                                    <i class="bi bi-send"></i> Publish Post
                                {% endif %}
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Character count and word count -->
<div class="position-fixed bottom-0 end-0 m-3" style="z-index: 1000;">
    <div class="card shadow-sm">
        <div class="card-body py-2 px-3">
            <div class="d-flex align-items-center text-muted small">
                <i class="bi bi-bar-chart me-2"></i>
                <span id="word-count">0 words</span>
                <span class="mx-2">•</span>
                <span id="char-count">0 characters</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const contentTextarea = document.getElementById('{{ form.content.id_for_label }}');
    const previewArea = document.getElementById('preview-area');
    const writeModeBtn = document.getElementById('write-mode');
    const previewModeBtn = document.getElementById('preview-mode');
    const wordCountEl = document.getElementById('word-count');
    const charCountEl = document.getElementById('char-count');
    const saveDraftBtn = document.getElementById('save-draft');
    
    // Auto-resize textarea
    function autoResize() {
        contentTextarea.style.height = 'auto';
        contentTextarea.style.height = contentTextarea.scrollHeight + 'px';
    }
    
    // Update word and character count
    function updateCounts() {
        const text = contentTextarea.value;
        const words = text.trim() ? text.trim().split(/\s+/).length : 0;
        const chars = text.length;
        
        wordCountEl.textContent = `${words} word${words !== 1 ? 's' : ''}`;
        charCountEl.textContent = `${chars} character${chars !== 1 ? 's' : ''}`;
    }
    
    // Simple markdown to HTML converter
    function markdownToHtml(text) {
        return text
            .replace(/^### (.*$)/gm, '<h3>$1</h3>')
            .replace(/^## (.*$)/gm, '<h2>$1</h2>')
            .replace(/^# (.*$)/gm, '<h1>$1</h1>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code>$1</code>')
            .replace(/~~(.*?)~~/g, '<s>$1</s>')
            .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
            .replace(/^> (.+)/gm, '<blockquote class="blockquote">$1</blockquote>')
            .replace(/^- (.+)/gm, '<ul><li>$1</li></ul>')
            .replace(/^(\d+)\. (.+)/gm, '<ol><li>$2</li></ol>')
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br>')
            .replace(/^(.+)/, '<p>$1')
            .replace(/(.+)$/, '$1</p>')
            .replace(/<\/ul>\s*<ul>/g, '')
            .replace(/<\/ol>\s*<ol>/g, '');
    }
    
    // Update preview
    function updatePreview() {
        const content = contentTextarea.value;
        if (content.trim()) {
            previewArea.innerHTML = '<div class="markdown-content">' + markdownToHtml(content) + '</div>';
        } else {
            previewArea.innerHTML = '<div class="text-muted text-center py-5"><i class="bi bi-eye-slash"></i><p>Start writing to see the preview...</p></div>';
        }
    }
    
    // Mode switching
    writeModeBtn.addEventListener('change', function() {
        if (this.checked) {
            contentTextarea.style.display = 'block';
            previewArea.style.display = 'none';
        }
    });
    
    previewModeBtn.addEventListener('change', function() {
        if (this.checked) {
            updatePreview();
            contentTextarea.style.display = 'none';
            previewArea.style.display = 'block';
        }
    });
    
    // Markdown toolbar actions
    document.querySelectorAll('.markdown-toolbar button').forEach(button => {
        button.addEventListener('click', function() {
            const action = this.dataset.action;
            const start = contentTextarea.selectionStart;
            const end = contentTextarea.selectionEnd;
            const selectedText = contentTextarea.value.substring(start, end);
            let replacement = '';
            
            switch(action) {
                case 'bold':
                    replacement = `**${selectedText || 'bold text'}**`;
                    break;
                case 'italic':
                    replacement = `*${selectedText || 'italic text'}*`;
                    break;
                case 'link':
                    replacement = `[${selectedText || 'link text'}](url)`;
                    break;
                case 'h1':
                    replacement = `# ${selectedText || 'Heading 1'}`;
                    break;
                case 'h2':
                    replacement = `## ${selectedText || 'Heading 2'}`;
                    break;
                case 'h3':
                    replacement = `### ${selectedText || 'Heading 3'}`;
                    break;
                case 'ul':
                    replacement = `- ${selectedText || 'List item'}`;
                    break;
                case 'ol':
                    replacement = `1. ${selectedText || 'List item'}`;
                    break;
                case 'quote':
                    replacement = `> ${selectedText || 'Quote'}`;
                    break;
                case 'code':
                    replacement = `\`${selectedText || 'code'}\``;
                    break;
            }
            
            contentTextarea.value = contentTextarea.value.substring(0, start) + replacement + contentTextarea.value.substring(end);
            contentTextarea.focus();
            
            // Update cursor position
            const newCursorPos = start + replacement.length;
            contentTextarea.setSelectionRange(newCursorPos, newCursorPos);
            
            autoResize();
            updateCounts();
        });
    });
    
    // Event listeners
    contentTextarea.addEventListener('input', function() {
        autoResize();
        updateCounts();
    });
    
    // Save draft functionality
    saveDraftBtn.addEventListener('click', function() {
        const formData = new FormData(document.getElementById('post-form'));
        // Here you would typically send an AJAX request to save draft
        // For now, just show a message
        alert('Draft saved locally! (This is a demo - implement server-side draft saving)');
    });
    
    // Auto-save draft every 30 seconds
    setInterval(function() {
        if (contentTextarea.value.trim()) {
            localStorage.setItem('blog-draft-title', document.getElementById('{{ form.title.id_for_label }}').value);
            localStorage.setItem('blog-draft-content', contentTextarea.value);
        }
    }, 30000);
    
    // Load draft on page load
    const draftTitle = localStorage.getItem('blog-draft-title');
    const draftContent = localStorage.getItem('blog-draft-content');
    if (draftTitle && draftContent && !document.getElementById('{{ form.title.id_for_label }}').value) {
        if (confirm('We found a saved draft. Would you like to restore it?')) {
            document.getElementById('{{ form.title.id_for_label }}').value = draftTitle;
            contentTextarea.value = draftContent;
        }
    }
    
    // Clear draft on successful submit
    document.getElementById('post-form').addEventListener('submit', function() {
        localStorage.removeItem('blog-draft-title');
        localStorage.removeItem('blog-draft-content');
    });
    
    // Initialize
    autoResize();
    updateCounts();
    
    // Set initial height
    contentTextarea.style.minHeight = '300px';
});
</script>
{% endblock %}